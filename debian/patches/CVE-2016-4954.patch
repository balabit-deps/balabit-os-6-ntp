Description: fix denial of service via spoofed packets
Bug: http://support.ntp.org/bin/view/Main/NtpBug3044
Origin: vendor, http://pkgs.fedoraproject.org/cgit/rpms/ntp.git/tree/ntp-4.2.6p5-cve-2016-4954.patch

Index: ntp-4.2.8p4+dfsg/ntpd/ntp_proto.c
===================================================================
--- ntp-4.2.8p4+dfsg.orig/ntpd/ntp_proto.c	2016-10-05 07:59:03.249447278 -0400
+++ ntp-4.2.8p4+dfsg/ntpd/ntp_proto.c	2016-10-05 07:59:03.241447205 -0400
@@ -1673,6 +1673,20 @@
 	    &p_org, &p_rec, &p_xmt, &peer->dst,
 	    pleap, pversion, pmode, pstratum, pkt->ppoll, pkt->precision,
 	    p_del, p_disp, pkt->refid);
+
+	/*
+	 * If any test failed in the receive() routine, the packet is
+	 * discarded.
+	 */
+	if (peer->flash & PKT_TEST_MASK) {
+#ifdef DEBUG
+		if (debug)
+			printf("packet: flash header %04x\n",
+			    peer->flash);
+#endif
+		return;
+	}
+
 	peer->leap = pleap;
 	peer->stratum = min(pstratum, STRATUM_UNSPEC);
 	peer->pmode = pmode;
@@ -1709,11 +1723,6 @@
 	if (p_del / 2 + p_disp >= MAXDISPERSE)	/* test 7 */
 		peer->flash |= TEST7;		/* bad header */
 
-	/*
-	 * If any tests fail at this point, the packet is discarded.
-	 * Note that some flashers may have already been set in the
-	 * receive() routine.
-	 */
 	if (peer->flash & PKT_TEST_MASK) {
 		peer->seldisptoolarge++;
 #ifdef DEBUG
