Description: fix authenticated broadcast mode off-path denial of service
Origin: vendor, http://pkgs.fedoraproject.org/cgit/rpms/ntp.git/tree/ntp-4.2.6p5-cve-2015-7979.patch
Bug: http://support.ntp.org/bin/view/Main/NtpBug2942

Index: ntp-4.2.8p4+dfsg/ntpd/ntp_proto.c
===================================================================
--- ntp-4.2.8p4+dfsg.orig/ntpd/ntp_proto.c	2016-05-31 13:46:43.345056332 -0400
+++ ntp-4.2.8p4+dfsg/ntpd/ntp_proto.c	2016-05-31 13:46:43.341056282 -0400
@@ -1401,7 +1401,8 @@
 		report_event(PEVNT_AUTH, peer, "crypto_NAK");
 		peer->flash |= TEST5;		/* bad auth */
 		peer->badauth++;
-		if (peer->flags & FLAG_PREEMPT) {
+		if (peer->flags & FLAG_PREEMPT && hismode != MODE_BROADCAST &&
+		    !(peer->flash & (TEST2 | TEST3))) {
 			unpeer(peer);
 			return;
 		}
@@ -1427,7 +1428,8 @@
 		if (   has_mac
 		    && (hismode == MODE_ACTIVE || hismode == MODE_PASSIVE))
 			fast_xmit(rbufp, MODE_ACTIVE, 0, restrict_mask);
-		if (peer->flags & FLAG_PREEMPT) {
+		if (peer->flags & FLAG_PREEMPT && hismode != MODE_BROADCAST &&
+		    !(peer->flash & (TEST2 | TEST3))) {
 			unpeer(peer);
 			return;
 		}
