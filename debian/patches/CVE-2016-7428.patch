Backport of:

    TOPntp-stable1.3686.19.1 changes

NTP - Network Time Protocol
#### ChangeSet ####

2016-10-20 09:21:04+02:00, perlinger@ntp.org
  [Sec 3113] Broadcast Mode Poll Interval Enforcement DoS

#==== ChangeLog ====
#
#2016-10-20 09:21:04+02:00, perlinger@ntp.org +4 -0
#  [Sec 3113] Broadcast Mode Poll Interval Enforcement DoS
#--- 1.1834/ChangeLog	2016-06-02 11:39:59 +00:00
#+++ 1.1834.19.1/ChangeLog	2016-10-20 07:21:04 +00:00
#@@ -1,3 +1,7 @@
#+---
#+* [Sec 3113] Broadcast Mode Poll Interval Enforcement DoS <perlinger@ntp.org>
#+  - applied fix as suggested by Matthew Van Gundy
#+ 
# ---
# (4.2.8p8) 2016/06/02 Released by Harlan Stenn <stenn@ntp.org>
#
#
#==== include/ntp.h ====
#
#2016-10-20 09:21:04+02:00, perlinger@ntp.org +1 -1
#  [Sec 3113] Broadcast Mode Poll Interval Enforcement DoS
Index: ntp-4.2.8p4+dfsg/include/ntp.h
===================================================================
--- ntp-4.2.8p4+dfsg.orig/include/ntp.h	2017-06-28 10:09:17.326110081 -0400
+++ ntp-4.2.8p4+dfsg/include/ntp.h	2017-06-28 10:09:17.326110081 -0400
@@ -383,7 +383,7 @@ struct peer {
 	 * Statistic counters
 	 */
 	u_long	timereset;	/* time stat counters were reset */
-	u_long	timelastrec;	/* last packet received time */
+	u_long	timelastrec;	/* last packet received time, incl. trash */
 	u_long	timereceived;	/* last (clean) packet received time */
 	u_long	timereachable;	/* last reachable/unreachable time */
 
Index: ntp-4.2.8p4+dfsg/ntpd/ntp_proto.c
===================================================================
--- ntp-4.2.8p4+dfsg.orig/ntpd/ntp_proto.c	2017-06-28 10:09:17.314109908 -0400
+++ ntp-4.2.8p4+dfsg/ntpd/ntp_proto.c	2017-06-28 10:10:10.014848722 -0400
@@ -1243,11 +1243,21 @@ receive(
 				++bail;
 			}
 
-			if (  (current_time - peer->timelastrec)
+			/* too early? worth an error, too!
+			 *
+			 * [Bug 3113] Ensure that at least one poll
+			 * interval has elapsed since the last **clean**
+			 * packet was received.  We limit the check to
+			 * **clean** packets to prevent replayed packets
+			 * and incorrectly authenticated packets, which
+			 * we'll discard, from being used to create a
+			 * denial of service condition.
+			 */
+			if (  (current_time - peer->timereceived)
 			    < (1 << pkt->ppoll)) {
 				msyslog(LOG_INFO, "receive: broadcast packet from %s arrived after %ld, not %d seconds!",
 					stoa(&rbufp->recv_srcadr),
-					(current_time - peer->timelastrec),
+					(current_time - peer->timereceived),
 					(1 << pkt->ppoll)
 					);
 				++bail;
